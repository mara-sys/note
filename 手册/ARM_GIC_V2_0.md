# ARM Generic Interrupt Controller
## 第一章节 介绍
### 1.1 GIC 架构
GIC 定义了：
* 架构要求处理连接到 GIC 的所有处理器的所有中断源；
* 一个适用于单处理器或多处理器系统的通用中断控制器编程接口。 

注意：该架构描述了一种 GIC，设计用于与一个或多个符合 ARM A 和 R 架构配置文件的处理器一起使用。 然而，GIC 体系结构对用于实现 GIC 的处理器没有任何限制。

GIC 是一种集中资源，用于在包括至少一个处理器的系统中支持和管理中断。 它提供：
* 用于管理一个或多个处理器的中断源、中断行为和中断路由的寄存器
* 支持：
  * ARM 架构安全扩展 
  * ARM 架构虚拟化扩展 
  * enabling, disabling, and generating processor interrupts from hardware (peripheral) interrupt sources
  * 软件生成的中断 (SGI) 
  * 中断屏蔽和优先级 
  * 单处理器和多处理器环境 
  * 电源管理环境中的唤醒事件。 

GIC 包括中断分组功能，支持：
* 将每个中断配置为 Group 0 或 Group 1 
* 使用 IRQ 或 FIQ 异常请求向目标处理器发送组 0 中断信号 
* 仅使用 IRQ 异常请求向目标处理器发送组 1 中断信号 
* 处理 0 组和 1 组中断优先级的统一方案 
* Group 0 的某些中断配置是可选锁定的
  
注意：
* 中断分组存在于所有 GICv2 实现和包含 GIC 安全扩展的 GICv1 实现中，请参阅第 1-15 页的规范 2.0 版中的更改。 
* 在许多实现中，IRQ 和 FIQ 中断请求对应于<u> ARM 架构的所有变体（微控制器配置文件（M 配置文件）除外）都支持的 IRQ 和 FIQ 异步异常</u>，。 有关 IRQ、FIQ 和异步异常的详细信息，请参阅 ARM 体系结构参考手册，ARMv7-A 和 ARMv7-R 版。 

### 1.2 安全扩展支持 
ARM 处理器安全扩展是 ARMv7-A 架构配置文件的可选扩展。 这意味着 ARMv7-A 实现是否包含安全扩展是由实现定义的。 ARM 安全扩展通过以下方式促进安全应用程序的开发： 
* 将硬件安全功能集成到架构中 
* 提供 Secure 状态下的内存访问所访问的 Secure 虚拟内存空间 
* 提供 Non-secure 虚拟内存空间，供处于 Non-secure 状态的内存访问访问。 

See Processor security state and Secure and Non-secure GIC accesses on page 1-20 for more information.

当实现 GIC 安全扩展的 GIC 连接到实现 ARM 安全扩展的处理器时： 
* 0 组中断是安全中断，1 组中断是非安全中断。 
* 处理器访问 GIC 中的寄存器的行为取决于访问是安全还是非安全，请参阅处理器安全状态和安全和非安全 GIC 访问第 1-20 页。 除非本文档另有明确说明，否则访问 GIC 寄存器时 
  * 对保存安全中断状态信息的寄存器字段的非安全读取返回零 
  * GIC 会忽略对保存安全中断状态信息的寄存器字段的任何非安全写入。 

......

## 1.4 术语 
以下部分定义了本规范中使用的架构术语：
### 1.4.1 中断状态
以下状态适用于 GIC 和连接的处理器之间的每个接口： 
Inactive：非活动或挂起的中断。 
Pending：从源到 GIC 的中断，被识别为在硬件中断言或由软件生成，并等待目标处理器提供服务。 
Active：从源到 GIC 的中断，该中断已被处理器确认，正在接受服务但尚未完成。 
Active and pending：处理器正在为中断提供服务，而 GIC 有来自同一源的挂起中断。 
### 1.4.2 中断类型
实现此 GIC 架构的设备可以管理以下类型的中断： 
* 外设中断：这是由 GIC 的信号断言的中断。 GIC 架构定义了以下类型的外设中断： 
  * Private Peripheral Interrupt (PPI) 私有外设中断：这是特定于每个处理器的外设中断。 
  * Shared Peripheral Interrupt (SPI) 共享外设中断：这是一个外设中断，分发器可以将此外设中断路由到任何指定的处理器组合。 
每个外设中断是： 
    * 边沿触发：这是一种中断，在检测到中断信号的上升沿时被断言，然后无论信号状态如何，都保持断言，直到它被本规范定义的条件清除。 
    * 电平触发：这是一个中断，只要中断信号电平处于活动状态就会置位，并且在电平未处于活动状态时解除置位。 
注意：当一个电平敏感中断被断言时，它在 GIC 中的状态是挂起的，或者是活动的和挂起的。 如果外设因任何原因取消断言中断信号，GIC 将从中断中删除挂起状态。 有关详细信息，请参阅第 3-41 页的中断处理状态机。 

* 软件产生的中断（SGI）：这是由软件写入 GIC 中的 GICD_SGIR 寄存器产生的中断。 系统使用 SGI 进行处理器间通信。
SGI 具有边缘触发属性。 中断的软件触发相当于中断请求信号的边沿跳变。
当 SGI 在多处理器实现中发生时，中断确认寄存器 GICC_IAR 或别名中断确认寄存器 GICC_AIAR 中的 CPUID 字段标识请求中断的处理器。
在包含 GIC 虚拟化扩展的实现中： 
  * 当 SGI 发生时，GIC 虚拟化扩展中的管理寄存器使能了要求处理器能够按照 GIC 规范的要求报告给客户操作系统 
  * 通过写入 GIC 虚拟化扩展中的管理寄存器，管理程序可以生成虚拟中断，在虚拟机中显示为 SGI。 
See Software-generated interrupts on page 5-165 and List Registers, GICH_LRn on 
page 5-176 for more information.
* 虚拟中断：在实现 GIC 虚拟化扩展的 GIC 中，一种针对处理器上运行的虚拟机的中断，通常由连接的虚拟 CPU 接口向处理器发送信号。 有关详细信息，请参阅第 2-22 页的关于 GIC 分区。 
* Maintenance interrupt（维护中断）：在实现 GIC 虚拟化扩展的 GIC 中，一种级别敏感的中断，用于向关键事件发出信号，例如启用或禁用特定中断组。 有关详细信息，请参阅第 5-164 页的维护中断。
#### 1.4.3 处理中断的模型 
注意：在描述 GIC 中断处理模型时，术语 1-N 和 N-N 与术语 1:N 和 N:N 的数学用法不对应。
在多处理器实现中，有两种处理中断的模型： 
* 1-N model：只有一个处理器处理这个中断。 系统必须实现一种机制来确定哪个处理器处理<u>被编程为针对多个处理器的中断</u>。 
注意：
  * ARM GIC 架构不保证 1-N 中断呈现给： 
    * 目标处理器列表中列出的所有处理器 
    * 启用的接口，其中至少启用了一个接口。 
  * 1-N 中断可能会呈现给处理器已屏蔽中断事件的接口，请参阅第 3-41 页的 1-N 模型的影响。
* N-N model：所有处理器独立接收中断。 当处理器确认中断时，只有该处理器的中断挂起状态被清除。 其他处理器的中断保持挂起。 
#### 1.4.4 虚假中断 
有可能发生这种情况：GIC 向处理器发出的中断信号已经不再被需要了。 如果发生这种情况，当处理器确认回应了（acknowledges）中断时，GIC 会返回一个特殊的中断 ID，将中断标识为虚假中断。 虚假中断的原因有： 
* 在处理器确认中断之前： 
  * 软件改变了中断的优先级
  * 软件失能了中断
  * 软件改变了中断的目标处理器。
* 对于 1-N 模型中断，另一个目标处理器提前回应了（acknowledged）中断
#### 1.4.5 处理器安全状态以及安全和非安全 GIC 访问 
实现 ARM 安全扩展的处理器具有安全状态，安全或非安全：
* 处于非安全状态的处理器只能对 GIC 进行非安全访问 
* 处于安全状态的处理器可以对 GIC 进行安全和非安全访问 
* 在非安全状态下运行的软件被描述为非安全软件 
* 以安全状态运行的软件称为安全软件。 

有关在处理器上实现安全扩展的更多信息，请参阅 ARM Architecture 
Reference Manual, ARMv7-A and ARMv7-R edition。 
具有实现安全扩展的 GIC 的多处理器系统可能包括一个或多个未实现安全扩展的处理器。 实现这样的处理器，以便： 
* 它只对 GIC 进行安全访问，这意味着在处理器上运行的任何软件都是只能对 GIC 进行安全访问的安全软件 
* 它只对 GIC 进行非安全访问，这意味着在处理器上运行的任何软件都是非安全软件。 

#### 1.4.6 Banking
Banking 在 ARM 架构规范中具有特殊的含义： 
* Interrupt banking：在多处理器实现中，对于 PPI 和 SGI，GIC 可以有多个具有相同中断 ID 的中断。 此类中断称为`banked interrupt`，并由其中断 ID 及其关联的 CPU 的接口组合成唯一标识。 For more information see Interrupt IDs on page 2-24.
* Register banking：寄存器银行是指在同一地址实现寄存器的多个副本。 出现这种情况： 
  * 在多处理器实现中，为每个处理器提供与存储中断相对应的寄存器的单独副本 
  * 在实现安全扩展的 GIC 中，提供某些寄存器的单独安全和非安全副本。 
For more information see Register banking on page 4-77.
## 第二章 GIC Partitioning
本章介绍了主要 GIC 接口和组件的架构划分，并介绍了主要 GIC 组件、分发器和 CPU 接口的功能。
### 2.1 关于 GIC partitioning
GIC 架构在逻辑上分为一个 Distributor 块和一个或多个 CPU 接口块。 GIC 虚拟化扩展向 GIC 添加一个或多个虚拟 CPU 接口。 因此，如第 2-23 页的图 2-1 所示，GIC 的逻辑分区如下： 
* Distributor（分发器）：分发器模块执行中断优先级排序并分配连接到系统中的处理器的 CPU 接口。分发器模块的寄存器由 GICD_ 前缀标识。
* CPU interfaces（CPU 接口）：每个 CPU 接口模块块为系统中连接的处理器执行优先级屏蔽和抢占处理。CPU 接口模块寄存器由 GICC_ 前缀标识。在描述包含 GIC 虚拟化扩展的 GIC 时，CPU 接口有时称为物理 CPU 接口，以避免可能与虚拟 CPU 接口混淆。 
* Virtual CPU interfaces（虚拟 CPU 接口）： GIC 虚拟化扩展为系统中的每个处理器添加了一个虚拟 CPU 接口。 每个虚拟 CPU 接口被划分为以下块：
  * Virtual interface control：虚拟接口控制块的主要组件是 GIC 虚拟接口控制寄存器，其中包括连接处理器上当前虚拟机的活动和挂起虚拟中断列表。 通常，这些寄存器由在该处理器上运行的管理程序管理。 虚拟接口控制块寄存器由 GICH_ 前缀标识。 
  * Virtual CPU interface：每个虚拟 CPU 接口块向连接的处理器提供虚拟中断的物理信号。 ARM 处理器虚拟化扩展将这些中断信号发送到该处理器上的当前虚拟机。 虚拟机访问的 GIC 虚拟 CPU 接口寄存器为虚拟中断提供中断控制和状态信息。 这些寄存器的格式类似于物理 CPU 接口寄存器的格式。
虚拟 CPU 接口块寄存器由 GICV_ 前缀标识。
注意：虚拟 CPU 接口不支持 Power management, GIC v2 on page 2-31 中描述的电源管理功能。

一个 GIC 最多可以实现 8 个 CPU 接口，编号为 0-7。 在实现 GIC Virtualization Extensions 的 GIC 中，虚拟 CPU 接口编号与 CPU 接口编号相对应，因此 CPU 接口 0 和虚拟 CPU 接口 0 连接到同一处理器。 
此模型支持在单处理或多处理环境中实现 GIC，并且 GIC 虚拟化扩展将该支持扩展到支持虚拟化的处理器，其中处于非安全状态：
* Guest 操作系统在虚拟机上运行 
* 管理程序负责在虚拟机之间切换。 这种切换包括切换 GIC 虚拟接口控制寄存器中保持的状态。 

每个块都提供了 GIC 编程模型的一部分，并且： 
* 对于每个实现的 CPU 接口，编程模型通常是相同的。 
* 虚拟 CPU 接口的编程模型通常与物理 CPU 接口的编程模型相同。 

注意：
* 本节中描述的 GIC 分区是一种架构抽象。 这些块是单独实现还是组合实现取决于具体实现。
* 在多处理器系统中实现 GIC 安全扩展的 GIC 中，可以实现 CPU 接口，以便它接收： 
  * 安全和非安全访问 
  * 仅安全访问
  * 仅非安全访问

框架图：

本章的其余部分以及第 3 章中断处理和优先级以及第 4 章程序员模型描述了没有 GIC 虚拟化扩展的 GIC。 第 5 章虚拟化的 GIC 支持描述了 GIC 虚拟化扩展添加的功能。 
### 2.2 分发器
Distributor 集中所有中断源，确定每个中断的优先级，并为每个 CPU 接口将优先级最高的中断转发给该接口，进行优先级屏蔽和抢占处理。
Distributor 提供了一个编程接口，用于： 
* 
